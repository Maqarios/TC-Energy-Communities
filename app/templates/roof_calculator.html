{% extends 'base.html' %}

{% block title %}Roof Calculator{% endblock %}

{% block content_header %}
<h2>Roof Area Selector</h2>
<p>Enter the address to find the location and select roof areas.</p>
<div class="row">
    <div class="col-6 col-12">
        <ul class="actions fit">
            <li>
                <div class="col-6 col-12">
                    <label for="address">Address</label>
                    <input type="text" name="address" id="address" placeholder="Enter Address">
                </div>
            </li>
        </ul>
        <ul class="col-6 actions">
            <li><button id="get-image" class="button">Get Satellite Image</button></li>
        </ul>
    </div>
</div>
{% endblock %}

{% block content %}
<section id="roof-calculator">
    <div class="container">
        <div id="map-container">
            <div id="map" style="width: {{ img_width }}px; height: {{ img_height }}px;"></div>
        </div>
        <div id="polygon-list-container" style="display: none;">
            <h3>Selected Roof Areas</h3>
            <div class="table-wrapper">
                <table class="alt" id="polygon-table">
                    <thead>
                        <tr>
                            <th>Visibility</th>
                            <th>Name</th>
                            <th>Feature Type</th>
                            <th>Roof Type</th>
                            <th>Tilt</th>
                            <th>Azimuth</th>
                        </tr>
                    </thead>
                    <tbody id="polygon-list">
                        <!-- Polygon items will be added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <ul class="actions fir">
        <li>
            <button id="calculate" class="button">Calculate</button>
        </li>
    </ul>
    <div id="error-message" class="error" style="display: none;">Place not found. Please try again.</div>
</section>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<style>
    #roof-calculator {
        padding: 20px;
    }

    .header {
        text-align: center;
        margin-bottom: 20px;
    }

    .form-section {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
    }

    #address-form input {
        width: 300px;
        padding: 10px;
        margin-right: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
    }

    #address-form .button {
        padding: 10px 20px;
    }

    .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
    }

    #map-container {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
    }

    #map {
        width: 100%;
        height: auto;

        max-width: {
                {
                img_width
            }
        }

        px;

        max-height: {
                {
                img_height
            }
        }

        px;
    }

    #polygon-list-container {
        text-align: center;
        margin-bottom: 20px;
        width: 100%;
        max-width: 100%;
    }

    .polygon-item {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 10px;
    }

    .polygon-item select,
    .polygon-item input[type="text"],
    .polygon-item button {
        margin: 0 5px;
    }

    .button-container {
        text-align: center;
    }

    .error {
        text-align: center;
        color: red;
    }

    .visibility-checkbox-container {
        display: flex;
        align-items: center;
    }

    .visibility-checkbox-label {
        margin-left: 5px;
    }

    @media (max-width: 768px) {
        #map {
            width: 100%;
            height: auto;
        }
    }
</style>
<script>
    let map;
    let drawnItems;
    let polygonCount = 0;

    document.getElementById('get-image').addEventListener('click', function () {
        const address = document.getElementById('address').value;
        fetch('/get_image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ "address": address }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('error-message').style.display = 'block';
                    document.getElementById('map-container').style.display = 'none';
                    document.getElementById('polygon-list-container').style.display = 'none';
                    document.getElementById('polygon-list').innerHTML = '';
                } else {
                    document.getElementById('error-message').style.display = 'none';
                    document.getElementById('map-container').style.display = 'block';
                    initializeMap(data.image_url, data.width, data.height);
                    if (data.roofs && data.roofs.length > 0) {
                        document.getElementById('polygon-list-container').style.display = 'block';
                        data.roofs.forEach(polygon => {
                            addPolygonToMap(polygon);
                        });
                    }
                }
            });
    });

    function initializeMap(imageUrl, imgWidth, imgHeight) {
        if (map) {
            map.remove();
        }

        const bounds = [[0, 0], [imgHeight, imgWidth]];

        map = L.map('map', {
            center: [imgHeight / 2, imgWidth / 2],
            zoom: 0,
            crs: L.CRS.Simple,
            zoomControl: true,
            scrollWheelZoom: true,
            doubleClickZoom: true,
            boxZoom: true,
            keyboard: true,
            maxBounds: bounds,
            maxBoundsViscosity: 1.0
        });

        L.imageOverlay(imageUrl, bounds).addTo(map);
        map.fitBounds(bounds);

        if (drawnItems) {
            drawnItems.clearLayers();
        }

        drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        const drawControl = new L.Control.Draw({
            draw: {
                polygon: true,
                rectangle: true,
                circle: false,
                marker: false,
                circlemarker: false,
            },
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);

        document.getElementById('polygon-list').innerHTML = '';

        map.on('draw:created', function (e) {
            const layer = e.layer;
            const polygonId = generateUniquePolygonId();

            drawnItems.addLayer(layer);
            addPolygonItem(polygonId, layer);
        });

        map.on('draw:deleted', function (e) {
            e.layers.eachLayer(function (layer) {
                const polygonId = layer._leaflet_id;
                const row = document.querySelector(`tr[data-layer-id='${polygonId}']`);
                if (row) {
                    row.remove();
                }
            });
            togglePolygonListContainer();
        });
    }

    function addPolygonToMap(polygon) {
        const latlngs = polygon.coordinates.map(coord => [coord[0], coord[1]]);
        const layer = L.polygon(latlngs).addTo(drawnItems);
        const polygonId = generateUniquePolygonId();
        addPolygonItem(polygonId, layer);

        // Set additional properties (name, roofType, tilt, azimuth)
        const polygonItem = document.getElementById(polygonId);
        polygonItem.querySelector('input[type="text"]').value = polygon.name;
        polygonItem.querySelector('select.roof-type').value = polygon.roofType;
        polygonItem.querySelector('select.tilt').value = polygon.tilt;
        polygonItem.querySelector('select.azimuth').value = polygon.azimuth;
        polygonItem.querySelector('select.feature-type').value = polygon.featureType;

        document.getElementById('polygon-list-container').style.display = 'block';
    }

    function generateUniquePolygonId() {
        const timestamp = new Date().getTime();
        return `polygon-${timestamp}-${polygonCount++}`;
    }

    function addPolygonItem(polygonId, layer) {
        const polygonList = document.getElementById('polygon-list');
        const row = document.createElement('tr');
        row.id = polygonId;

        // Set a custom data attribute to link the HTML element with the Leaflet layer
        row.setAttribute('data-layer-id', layer._leaflet_id);

        const visibilityCell = document.createElement('td');
        const visibilityCheckboxContainer = document.createElement('div');
        const visibilityCheckbox = document.createElement('input');
        visibilityCheckbox.type = 'checkbox';
        visibilityCheckbox.id = `visibility-${polygonId}`;
        visibilityCheckbox.name = `visibility-${polygonId}`;
        visibilityCheckbox.checked = true;
        visibilityCheckbox.onchange = function () {
            if (this.checked) {
                map.addLayer(layer);
            } else {
                map.removeLayer(layer);
            }
        };
        const visibilityLabel = document.createElement('label');
        visibilityLabel.setAttribute('for', `visibility-${polygonId}`);
        visibilityLabel.className = 'visibility-checkbox-label';
        visibilityCheckboxContainer.appendChild(visibilityCheckbox);
        visibilityCheckboxContainer.appendChild(visibilityLabel);
        visibilityCell.appendChild(visibilityCheckboxContainer);

        const nameCell = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        input.value = polygonId;
        input.onchange = function () {
            const existingTooltip = layer.getTooltip() ? layer.getTooltip().getContent().split('<br>')[1] : "";
            layer.bindTooltip("Name: " + this.value + "<br>" + existingTooltip).openTooltip();
        };
        nameCell.appendChild(input);

        const featureTypeCell = document.createElement('td');
        const featureTypeSelect = document.createElement('select');
        featureTypeSelect.className = 'feature-type';
        const roofOption = document.createElement('option');
        roofOption.value = 'roof';
        roofOption.text = 'Roof';
        featureTypeSelect.appendChild(roofOption);
        const obstacleOption = document.createElement('option');
        obstacleOption.value = 'obstacle';
        obstacleOption.text = 'Obstacle';
        featureTypeSelect.appendChild(obstacleOption);
        featureTypeCell.appendChild(featureTypeSelect);

        const roofTypeCell = document.createElement('td');
        const roofTypeSelect = document.createElement('select');
        roofTypeSelect.className = 'roof-type';
        const flatOption = document.createElement('option');
        flatOption.value = 'flat';
        flatOption.text = 'Flat';
        roofTypeSelect.appendChild(flatOption);
        const tiltOption = document.createElement('option');
        tiltOption.value = 'tilt';
        tiltOption.text = 'Tilt';
        roofTypeSelect.appendChild(tiltOption);
        roofTypeCell.appendChild(roofTypeSelect);

        const tiltCell = document.createElement('td');
        const tiltSelect = document.createElement('select');
        tiltSelect.className = 'tilt';
        for (let i = 0; i <= 50; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.text = i;
            if (i === 30) {
                option.selected = true;
            }
            tiltSelect.appendChild(option);
        }
        tiltCell.appendChild(tiltSelect);

        const azimuthCell = document.createElement('td');
        const azimuthSelect = document.createElement('select');
        azimuthSelect.className = 'azimuth';
        for (let i = 0; i < 360; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.text = i;
            azimuthSelect.appendChild(option);
        }
        azimuthCell.appendChild(azimuthSelect);

        row.appendChild(visibilityCell);
        row.appendChild(nameCell);
        row.appendChild(featureTypeCell);
        row.appendChild(roofTypeCell);
        row.appendChild(tiltCell);
        row.appendChild(azimuthCell);

        polygonList.appendChild(row);

        // Show the polygon list container
        document.getElementById('polygon-list-container').style.display = 'block';

        // Initial tooltip with just the name
        layer.bindTooltip("Name: " + polygonId).openTooltip();
    }

    document.getElementById('calculate').addEventListener('click', function () {
        const address = document.getElementById('address').value;
        if (!address) {
            alert("Please enter an address first.");
            return;
        }

        const roofs = [];
        const obstacles = [];
        const roofs_to_leaflet_ids = new Object();

        document.querySelectorAll('#polygon-list tr').forEach(item => {
            const polygonId = item.id;
            const name = item.querySelector('input[type="text"]').value;
            const roofType = item.querySelector('select.roof-type').value;
            const tilt = item.querySelector('select.tilt').value;
            const azimuth = item.querySelector('select.azimuth').value;
            const featureType = item.querySelector('select.feature-type').value;

            const layerId = parseInt(item.getAttribute('data-layer-id'), 10);
            const layer = drawnItems.getLayers().find(layer => layer._leaflet_id === layerId);
            if (layer && layer._latlngs) {
                const coordinates = layer.getLatLngs()[0].map(latlng => [latlng.lat, latlng.lng]);
                roofs_to_leaflet_ids[polygonId] = layerId;

                if (featureType === 'roof') {
                    roofs.push({
                        id: polygonId,
                        name,
                        roofType,
                        tilt,
                        azimuth,
                        featureType,
                        coordinates
                    });
                } else {
                    obstacles.push({
                        id: polygonId,
                        name,
                        roofType,
                        tilt,
                        azimuth,
                        featureType,
                        coordinates
                    });
                }
            }
        });

        fetch('/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                address,
                roofs,
                obstacles
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Error: " + data.error);
                } else {
                    // Clear existing rectangles
                    drawnItems.eachLayer(function (layer) {
                        if (layer.options.color === 'black') {
                            drawnItems.removeLayer(layer);
                        }
                    });

                    // Add estimated rectangles to the map
                    data.estimated_rectangles.forEach(rectangleData => {
                        const rectangle = L.polygon(rectangleData.coordinates, { color: 'black' });
                        drawnItems.addLayer(rectangle);
                    });

                    // Update tooltips with area and roof_kWp for each roof polygon
                    data.roofs.forEach(polygon => {
                        console.log(drawnItems.getLayers())
                        const layer = drawnItems.getLayers().find(layer => layer._leaflet_id === parseInt(roofs_to_leaflet_ids[polygon.id], 10));
                        const area = polygon.area_sqm;
                        const roof_kWp = polygon.roof_kWp;
                        layer.bindTooltip("Name: " + polygon.name + "<br>Area: " + area.toFixed(2) + " sqm<br>Power: " + roof_kWp.toFixed(2) + " kWp").openTooltip();
                    });
                }
            });
    });

    function togglePolygonListContainer() {
        const polygonList = document.getElementById('polygon-list');
        const polygonListContainer = document.getElementById('polygon-list-container');
        if (polygonList.children.length === 0) {
            polygonListContainer.style.display = 'none';
        } else {
            polygonListContainer.style.display = 'block';
        }
    }
</script>
{% endblock %}