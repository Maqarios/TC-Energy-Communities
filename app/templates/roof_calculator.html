{% extends 'base.html' %}

{% block title %}Select Roof Areas{% endblock %}

{% block content %}
<form id="address-form">
    <input type="text" name="address" id="address" placeholder="Enter Address">
    <button type="submit">Get Image</button>
</form>
<div id="map-container">
    <div id="map" style="width: {{ img_width }}px; height: {{ img_height }}px;"></div>
</div>
<div id="polygon-list"></div>
<div id="error-message" style="display: none;">Place not found. Please try again.</div>
<button id="save-polygons" style="margin-top: 20px;">Save Polygons</button>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<style>
    #polygon-list {
        margin-top: 20px;
    }

    .polygon-item {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
    }

    #error-message {
        color: red;
    }
</style>
<script>
    let map;
    let drawnItems;
    let polygonCount = 0;

    document.getElementById('address-form').addEventListener('submit', function (e) {
        e.preventDefault();
        fetch('/get_image', {
            method: 'POST',
            body: new FormData(this)
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('error-message').style.display = 'block';
                    document.getElementById('map-container').style.display = 'none';
                    document.getElementById('polygon-list').innerHTML = '';
                } else {
                    document.getElementById('error-message').style.display = 'none';
                    document.getElementById('map-container').style.display = 'block';
                    initializeMap(data.image_url, data.width, data.height);
                    if (data.polygons && data.polygons.length > 0) {
                        data.polygons.forEach(polygon => {
                            addPolygonToMap(polygon);
                        });
                    }
                }
            });
    });

    function initializeMap(imageUrl, imgWidth, imgHeight) {
        if (map) {
            map.remove();
        }

        const bounds = [[0, 0], [imgHeight, imgWidth]];

        map = L.map('map', {
            center: [imgHeight / 2, imgWidth / 2],
            zoom: 0,
            crs: L.CRS.Simple,
            zoomControl: true,
            scrollWheelZoom: true,
            doubleClickZoom: true,
            boxZoom: true,
            keyboard: true,
            maxBounds: bounds,
            maxBoundsViscosity: 1.0
        });

        L.imageOverlay(imageUrl, bounds).addTo(map);
        map.fitBounds(bounds);

        if (drawnItems) {
            drawnItems.clearLayers();
        }

        drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        const drawControl = new L.Control.Draw({
            draw: {
                polygon: true,
                rectangle: true,
                circle: false,
                marker: false,
                circlemarker: false,
            },
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);

        document.getElementById('polygon-list').innerHTML = '';

        map.on('draw:created', function (e) {
            const layer = e.layer;
            const polygonId = generateUniquePolygonId();

            drawnItems.addLayer(layer);
            addPolygonItem(polygonId, layer);
        });
    }

    function addPolygonToMap(polygon) {
        const latlngs = polygon.coordinates.map(coord => [coord[0], coord[1]]);
        const layer = L.polygon(latlngs).addTo(drawnItems);
        const polygonId = generateUniquePolygonId();
        addPolygonItem(polygonId, layer);

        // Set additional properties (name, roofType, tilt, azimuth)
        const polygonItem = document.getElementById(polygonId);
        polygonItem.querySelector('input[type="text"]').value = polygon.name;
        polygonItem.querySelector('select.roof-type').value = polygon.roofType;
        polygonItem.querySelector('select.tilt').value = polygon.tilt;
        polygonItem.querySelector('select.azimuth').value = polygon.azimuth;
        polygonItem.querySelector('select.feature-type').value = polygon.featureType;
    }

    function generateUniquePolygonId() {
        const timestamp = new Date().getTime();
        return `polygon-${timestamp}-${polygonCount++}`;
    }

    function addPolygonItem(polygonId, layer) {
        const polygonList = document.getElementById('polygon-list');
        const div = document.createElement('div');
        div.className = 'polygon-item';
        div.id = polygonId;

        // Set a custom data attribute to link the HTML element with the Leaflet layer
        div.setAttribute('data-layer-id', layer._leaflet_id);

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.onchange = function () {
            if (this.checked) {
                map.addLayer(layer);
            } else {
                map.removeLayer(layer);
            }
        };

        const featureTypeSelect = document.createElement('select');
        featureTypeSelect.className = 'feature-type';
        const roofOption = document.createElement('option');
        roofOption.value = 'roof';
        roofOption.text = 'Roof';
        featureTypeSelect.appendChild(roofOption);
        const obstacleOption = document.createElement('option');
        obstacleOption.value = 'obstacle';
        obstacleOption.text = 'Obstacle';
        featureTypeSelect.appendChild(obstacleOption);

        const input = document.createElement('input');
        input.type = 'text';
        input.value = polygonId;
        input.onchange = function () {
            layer.bindTooltip(this.value).openTooltip();
        };

        const roofTypeSelect = document.createElement('select');
        roofTypeSelect.className = 'roof-type';
        const flatOption = document.createElement('option');
        flatOption.value = 'flat';
        flatOption.text = 'Flat';
        roofTypeSelect.appendChild(flatOption);
        const tiltOption = document.createElement('option');
        tiltOption.value = 'tilt';
        tiltOption.text = 'Tilt';
        roofTypeSelect.appendChild(tiltOption);

        const tiltSelect = document.createElement('select');
        tiltSelect.className = 'tilt';
        for (let i = 0; i <= 50; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.text = i;
            if (i === 30) {
                option.selected = true;
            }
            tiltSelect.appendChild(option);
        }

        const azimuthSelect = document.createElement('select');
        azimuthSelect.className = 'azimuth';
        for (let i = 0; i < 360; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.text = i;
            azimuthSelect.appendChild(option);
        }

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete';
        deleteButton.onclick = function () {
            map.removeLayer(layer);
            div.remove();
        };

        div.appendChild(checkbox);
        div.appendChild(featureTypeSelect);
        div.appendChild(input);
        div.appendChild(roofTypeSelect);
        div.appendChild(tiltSelect);
        div.appendChild(azimuthSelect);
        div.appendChild(deleteButton);
        polygonList.appendChild(div);
    }

    document.getElementById('save-polygons').addEventListener('click', function () {
        const address = document.getElementById('address').value;
        if (!address) {
            alert("Please enter an address first.");
            return;
        }

        const polygons = [];
        document.querySelectorAll('.polygon-item').forEach(item => {
            const polygonId = item.id;
            const name = item.querySelector('input[type="text"]').value;
            const roofType = item.querySelector('select.roof-type').value;
            const tilt = item.querySelector('select.tilt').value;
            const azimuth = item.querySelector('select.azimuth').value;
            const featureType = item.querySelector('select.feature-type').value;

            const layerId = parseInt(item.getAttribute('data-layer-id'), 10);
            const layer = drawnItems.getLayers().find(layer => layer._leaflet_id === layerId);
            if (layer && layer._latlngs) {
                const coordinates = layer._latlngs[0].map(latlng => [latlng.lat, latlng.lng]);

                polygons.push({
                    name,
                    roofType,
                    tilt,
                    azimuth,
                    featureType,
                    coordinates
                });
            }
        });

        fetch('/save_polygons', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                address,
                polygons
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Error saving polygons: " + data.error);
                } else {
                    alert("Polygons saved successfully to " + data.file_path);
                }
            });
    });
</script>
{% endblock %}